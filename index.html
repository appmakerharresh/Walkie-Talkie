<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WalkieTalk - Rugged Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@700&family=Orbitron:wght@400..900&display=swap" rel="stylesheet"/>
<style>
  :root {
    --background-dark: #1a202c;
    --surface-dark: #2d3748;
    --primary-green: #48bb78;
    --text-primary: #e2e8f0;
    --text-secondary: #a0aec0;
    --border-color: #4a5568;
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body { font-family:'Chakra Petch',sans-serif; background-color:var(--background-dark); color:var(--text-primary); display:flex; min-height:100vh; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
  .container { display:flex; flex:1; border:8px solid #2d3748; border-radius:1rem; overflow:hidden; }
  aside { width:320px; background-color:#151b23; border-right:1px solid var(--border-color); padding:16px; display:flex; flex-direction:column; gap:16px; }
  main { flex:1; display:flex; flex-direction:column; }
  header { display:flex; justify-content:space-between; align-items:center; background-color:#151b23; border-bottom:1px solid var(--border-color); padding:12px 40px; }
  header h2 { font-family:'Orbitron',sans-serif; text-transform:uppercase; font-size:1.125rem; letter-spacing:0.15em; }
  .search-input { display:flex; align-items:center; background-color:var(--surface-dark); border:1px solid var(--border-color); border-radius:6px; padding:0 8px; height:48px; }
  .search-input input { flex:1; background:transparent; border:none; color:var(--text-primary); font-size:1rem; padding-left:8px; }
  .search-input input::placeholder { color:var(--text-secondary); }
  .channel { display:flex; align-items:center; gap:12px; padding:8px 12px; border-radius:6px; cursor:pointer; }
  .channel.active { background-color: rgba(72,187,120,0.2); border-left:4px solid var(--primary-green); color:var(--text-primary); }
  .channel:hover:not(.active) { background-color: rgba(45,55,72,0.3); color:var(--text-primary); }
  .channel span { color:var(--primary-green); }
  .main-content { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:32px; background-image: radial-gradient(circle, #1a202c 50%, transparent 100%), linear-gradient(rgba(45,55,72,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(45,55,72,0.3) 1px, transparent 1px); background-size: 100% 100%, 20px 20px, 20px 20px; }
  .segmented-display { background-color:var(--surface-dark); border:2px solid var(--border-color); padding:16px 24px; border-radius:8px; text-align:center; text-shadow:0 0 5px var(--primary-green), 0 0 10px var(--primary-green); margin-bottom:32px; }
  .segmented-display h1 { font-family:'Orbitron',sans-serif; font-size:3rem; font-weight:bold; text-transform:uppercase; }
  .transmit-btn { position:relative; display:inline-flex; flex-direction:column; align-items:center; justify-content:center; border-radius:50%; background-color:#3c4a5e; border:4px solid #2d3748; padding:16px; font-family:'Chakra Petch',sans-serif; color:var(--text-primary); cursor:pointer; transition:all 0.2s ease; box-shadow:4px 4px 8px rgba(0,0,0,0.4), -4px -4px 8px rgba(255,255,255,0.05); min-width:128px; min-height:128px; text-align:center; }
  .transmit-btn:active { background-color:var(--primary-green); color:white; box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6), inset -4px -4px 8px rgba(255,255,255,0.1); border-color:rgba(72,187,120,0.5); }
  .transmit-btn span:first-child { font-size:3rem; line-height:1; }
  .transmit-btn span:last-child { font-size:1rem; text-transform:uppercase; margin-top:6px; }
  .status { display:flex; align-items:center; gap:16px; padding:16px; border:1px solid var(--border-color); border-radius:8px; background-color:var(--surface-dark); }
  .status .ping { position:relative; width:12px; height:12px; }
  .status .ping::before { content: ''; position:absolute; width:100%; height:100%; border-radius:50%; background-color: rgba(72,187,120,0.5); animation: ping 1s infinite; }
  .status .ping div { width:12px; height:12px; background-color:#48bb78; border-radius:50%; position:relative; }
  @keyframes ping { 0% { transform: scale(0.5); opacity:1; } 100% { transform: scale(2); opacity:0; } }
  @keyframes pulse { 0%,100% { transform: scale(1); opacity:1; } 50% { transform: scale(1.2); opacity:0.5; } }
</style>
</head>
<body>

<!-- Username Modal -->
<div id="usernameModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#2d3748;padding:32px;border-radius:12px;text-align:center;color:#e2e8f0;">
    <h2>Enter Your Username</h2>
    <input id="usernameInput" type="text" placeholder="Your Name" style="padding:8px 12px;margin-top:16px;font-size:1rem;border-radius:6px;border:none;outline:none;width:200px;">
    <br/>
    <button id="usernameBtn" style="margin-top:16px;padding:8px 16px;border:none;border-radius:6px;background:#48bb78;color:#fff;font-weight:bold;cursor:pointer;">Join</button>
  </div>
</div>

<div class="container">
  <aside>
    <div style="display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border-color);padding-bottom:16px;">
      <span class="material-symbols-outlined" style="font-size:32px;color:var(--primary-green)">sensors</span>
      <div>
        <h1 style="font-family:'Orbitron',sans-serif;text-transform:uppercase;font-weight:bold;">Comms</h1>
        <p style="font-weight:bold;color:var(--primary-green);font-size:0.875rem;">Status: Secure</p>
      </div>
    </div>
    <div class="search-input">
      <span class="material-symbols-outlined">search</span>
      <input type="text" placeholder="Scan Frequencies..." value=""/>
    </div>
    <div>
      <div class="channel active"><span class="material-symbols-outlined">cell_tower</span>Channel Alpha</div>
      <div class="channel"><span class="material-symbols-outlined">cell_tower</span>Channel Bravo</div>
      <div class="channel"><span class="material-symbols-outlined">cell_tower</span>Ops Net</div>
      <div class="channel"><span class="material-symbols-outlined">cell_tower</span>Command</div>
      <div class="channel"><span class="material-symbols-outlined">cell_tower</span>Logistics</div>
    </div>
  </aside>

  <main>
    <header>
      <div style="display:flex;align-items:center;gap:16px;">
        <h2>WalkieTalk v2.0</h2>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="display:flex;align-items:center;gap:4px;">
          <div style="width:12px;height:12px;background:red;border-radius:50%;animation:pulse 1s infinite;"></div>
          <span style="color:#f87171;font-weight:bold;font-size:0.875rem;">REC</span>
        </div>
        <div style="width:40px;height:40px;border:2px solid var(--border-color);border-radius:50%;background-image:url('https://lh3.googleusercontent.com/aida-public/AB6AXuDmdnEn6m-JdFrExt0BIgA3yDCH0LoJwNsTh2FXSIz3n9LOpcb9OVmu4a-eSuv9CwXzeZIRqagLe_a7XgveXED5lhj6AoJ8qXako9mbbP2D3xoon1UDItEfgSyEwBaDHtPGzwfYSt_W1NrHYmzpTWlCM8KVMI9X2hhV1CenGgUzmuMaxCKUlU6pANPVdqlWZ4H8wm7rlULBMjgyeF6cuWuacg8xG91soY-7CI7PKmoBTxphogrBnaHBPbWTnwL1npTqp7yPS1PHqIw');background-size:cover;"></div>
      </div>
    </header>

    <div class="main-content">
      <div class="segmented-display">
        <p style="font-size:1rem;color:var(--text-secondary);">Current Channel</p>
        <h1 id="current-channel">ALPHA</h1>
      </div>
      <button class="transmit-btn" id="transmitBtn">
        <span class="material-symbols-outlined">mic</span>
        <span>Transmit</span>
      </button>
      <div class="status">
        <div class="ping"><div></div></div>
        <span id="transmission-status">Transmission Active</span>
      </div>
      <!-- Local waveform canvas -->
      <canvas id="localWaveform" width="500" height="80" style="margin-top:16px;"></canvas>
    </div>
  </main>
</div>

<script>
let localStream, pc;
const transmitBtn = document.getElementById('transmitBtn');
const transmissionStatus = document.getElementById('transmission-status');
let currentChannel = document.getElementById('current-channel').textContent;
const localCanvas = document.getElementById('localWaveform');
const localCtx = localCanvas.getContext('2d');
let remoteUsers = {};
let userId = 'user_' + Math.random().toString(36).substr(2,9);
let username = 'You';

// Username modal
document.getElementById('usernameBtn').addEventListener('click', () => {
  const input = document.getElementById('usernameInput').value.trim();
  if(input) username = input;
  document.getElementById('usernameModal').style.display = 'none';
  init();
});

// Initialize WebRTC
async function init() {
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  localStream.getAudioTracks()[0].enabled = false;

  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // Remote tracks
  pc.ontrack = e => {
    const streamId = e.streams[0].id;
    if(!remoteUsers[streamId]) {
      const color = getRandomColor();
      const wrapper = document.createElement('div'); wrapper.style.margin='8px 0';

      const label = document.createElement('div');
      label.textContent = 'User ' + streamId.substr(0,4);
      label.style.color = '#fff';
      label.style.backgroundColor = color;
      label.style.padding = '2px 6px';
      label.style.borderRadius = '4px';
      label.style.display = 'inline-block';
      label.style.fontWeight = 'bold';
      label.style.marginBottom = '4px';
      wrapper.appendChild(label);

      const canvas = document.createElement('canvas');
      canvas.width=500; canvas.height=80;
      wrapper.appendChild(canvas);

      document.querySelector('.main-content').appendChild(wrapper);
      const ctx = canvas.getContext('2d');
      remoteUsers[streamId]={canvas,ctx,label,stream:e.streams[0],color};
      setupWaveform(canvas,ctx,e.streams[0],color);
    }
  };

  pc.onicecandidate = event => {
    if(event.candidate) google.script.run.sendSignal(currentChannel,{ ice:event.candidate, userId, username });
  };

  // Local waveform with colored username
  const localColor='#48bb78';
  const localWrapper=document.createElement('div'); localWrapper.style.margin='8px 0';
  const localLabel=document.createElement('div');
  localLabel.textContent=username;
  localLabel.style.color='#fff';
  localLabel.style.backgroundColor=localColor;
  localLabel.style.padding='2px 6px';
  localLabel.style.borderRadius='4px';
  localLabel.style.display='inline-block';
  localLabel.style.fontWeight='bold';
  localLabel.style.marginBottom='4px';
  localWrapper.appendChild(localLabel);
  localWrapper.appendChild(localCanvas);
  document.querySelector('.main-content').prepend(localWrapper);
  setupWaveform(localCanvas, localCtx, localStream, localColor);

  pollSignals();
}

// Poll GAS for signals
async function pollSignals() {
  const signals = await google.script.run.withSuccessHandler(processSignals).getSignals(currentChannel);
  setTimeout(pollSignals,1000);
}

// Process incoming signals
async function processSignals(signals){
  for(let s of signals){
    if(s.userId===userId) continue;
    if(s.offer){
      await pc.setRemoteDescription(new RTCSessionDescription(s.offer));
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      google.script.run.sendSignal(currentChannel,{ answer: pc.localDescription, userId, username });
    } else if(s.answer){
      await pc.setRemoteDescription(new RTCSessionDescription(s.answer));
    } else if(s.ice){
      try{ await pc.addIceCandidate(s.ice); }catch(e){}
    }
    // Update remote label
    if(s.username && remoteUsers[s.streamId]){
      remoteUsers[s.streamId].label.textContent=s.username;
      remoteUsers[s.streamId].label.style.backgroundColor=remoteUsers[s.streamId].color;
    }
  }
}

// Push-to-talk
transmitBtn.addEventListener('mousedown',()=>{ localStream.getAudioTracks()[0].enabled=true; transmissionStatus.textContent=`Talking on ${currentChannel}`; });
transmitBtn.addEventListener('mouseup',()=>{ localStream.getAudioTracks()[0].enabled=false; transmissionStatus.textContent=`Listening on ${currentChannel}`; });

// Waveform drawing
function setupWaveform(canvas,ctx,stream,color){
  const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const analyser=audioCtx.createAnalyser();
  const source=audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);
  analyser.fftSize=256;
  const bufferLength=analyser.frequencyBinCount;
  const dataArray=new Uint8Array(bufferLength);
  function draw(){
    requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(dataArray);
    ctx.fillStyle='#1a202c'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth=2; ctx.strokeStyle=color; ctx.beginPath();
    let x=0; const sliceWidth=canvas.width/bufferLength;
    for(let i=0;i<bufferLength;i++){
      const v=dataArray[i]/128.0; const y=v*canvas.height/2;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); x+=sliceWidth;
    }
    ctx.lineTo(canvas.width,canvas.height/2); ctx.stroke();
  }
  draw();
}

// Utility random color
function getRandomColor(){ const colors=['#FF5722','#FFC107','#03A9F4','#E91E63','#9C27B0','#FF9800']; return colors[Math.floor(Math.random()*colors.length)]; }

// Channel switching
document.querySelectorAll('.channel').forEach(ch=>{
  ch.addEventListener('click',()=>{
    document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    currentChannel=ch.textContent.trim();
    document.getElementById('current-channel').textContent=currentChannel.toUpperCase();
    if(pc) pc.close(); remoteUsers={};
    document.querySelectorAll('.main-content > div').forEach(d=>{
      if(d.querySelector('canvas') && d.querySelector('canvas').id!=='localWaveform') d.remove();
    });
    init();
  });
});
</script>

</body>
</html>
